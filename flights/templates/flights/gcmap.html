{% extends 'flights/base.html' %}

{% load static %}

{% block links %}<link rel="stylesheet" type="text/css" href="{% static 'flights/css/gcmap.css' %}" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>

<script src="http://www.webglearth.com/v2/api.js"></script>

<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

<script src="{% static 'flights/geo/arc.js' %}"></script>

<style>
    .leaflet-container {
        background: #7394bc;
    }
</style>
{% endblock %}


{% block content %}

<form id="routeform" class="topform" action="javascript:;" onsubmit="drawGcmap(this)">{% csrf_token %}
    <span>
        <input type="text" name="input_string" placeholder="Input route, e.g. CPH-LHR or EKCH-EGLL-KJFK" size="30" required pattern="[A-Za-z]{3,4}-[A-Za-z]{3,4}(-[A-Za-z]{3,4})*">
        <label for="input_string"></label>
    </span>
    <input type="submit" value="&blacktriangleright;">
</form>

<div id="map"></div>

<div id="leftbar"></div>

<script>
    function toggleLeftBar() {
        $('#leftbar').toggle('slide', {direction: 'left'}, 400);
    }
    
    function hideLeftBar() {
        $('#leftbar').hide('slide', {direction: 'left'}, 400);
    }
    
    function showLeftBar() {
        $('#leftbar').show('slide', {direction: 'left'}, 400);
    }
    
    function printLeftBar(innerhtml) {
        document.getElementById('leftbar').innerHTML = innerhtml;
    }
</script>

<script>
    var map = L.map('map', {zoomControl: false, worldCopyJump: true}).setView([0, 0], 2);

    L.control.zoom({position: 'bottomleft'}).addTo(map);

    var myGeoJSONPath = '{% static "flights/geo/countries-hires.json" %}';
    var myCustomStyle = {
        stroke: true,
        color: '#6e7a8c',
        weight: 0.25,
        fill: true,
        fillColor: '#ccc6b3',
        fillOpacity: 1,
        clickable: false
    }

    $.getJSON(myGeoJSONPath, function(data) {
        L.geoJson(data, {
            clickable: false,
            style: myCustomStyle
        }).addTo(map).bringToBack();
    });

    var x = 12;
    var icon1 = L.icon({
        iconUrl: "{% static 'flights/img/1.png' %}",
        iconSize: [x, x],
        iconAnchor: [x/2, x/2],
        popupAnchor: [0, 0]
    });
</script>

<script>
    function drawGcmap(form) {        
        $.ajax({
            url: '{% url "draw_gcmap" %}',
            data: {
                'input_string': form.input_string.value
            },
            dataType: 'json',
            success: function (data) {
                var airports = $.parseJSON(data);

                for (i = 0; i < airports.length; i++) {
                    var marker = new L.marker([airports[i].fields.latitude, airports[i].fields.longitude], {icon: icon1}).bindPopup(airports[i].name).addTo(map);
                }
                
                for (i = 0; i < airports.length - 1; i++) {
                    var generator = new arc.GreatCircle({x: airports[i].fields.longitude, y: airports[i].fields.latitude },
                                                        {x: airports[i+1].fields.longitude, y: airports[i+1].fields.latitude },
                                                        {'name': 'test'});
                    var line = generator.Arc(100, {offset: 10});
                    L.geoJson(line.json(), {weight: 2, clickable: false, color: '#646464'}).addTo(map);
                }
            }
        });
    }
</script>

{% endblock %}