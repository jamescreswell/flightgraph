{% extends 'flights/base.html' %}

{% load static %}

{% block links %}<link rel="stylesheet" type="text/css" href="{% static 'flights/css/gcmap.css' %}" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>

<script src="http://www.webglearth.com/v2/api.js"></script>

<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

<script src="{% static 'flights/geo/arc.js' %}"></script>

<style>
    .leaflet-container {
        background: #7394bc;
    }
</style>
{% endblock %}


{% block content %}

<form id="routeform" class="topform" action="{% url 'gcmap' %}" method="post">{% csrf_token %}
    <span>
        <input type="text" name="input_string" placeholder="Input route, e.g. CPH-LHR or EKCH-EGLL-KJFK" size="30" required pattern="[A-Za-z]{3,4}-[A-Za-z]{3,4}(-[A-Za-z]{3,4})*">
        <label for="input_string"></label>
    </span>
    <input type="submit" value="&blacktriangleright;">
</form>

<div id="map"></div>

<div id="leftbar"></div>

<script>
    function toggleLeftBar() {
        $('#leftbar').toggle('slide', {direction: 'left'}, 400);
    }
    
    function hideLeftBar() {
        $('#leftbar').hide('slide', {direction: 'left'}, 400);
    }
    
    function showLeftBar() {
        $('#leftbar').show('slide', {direction: 'left'}, 400);
    }
    
    function printLeftBar(innerhtml) {
        document.getElementById('leftbar').innerHTML = innerhtml;
    }
</script>

<script>
    function drawMap() {
        {% if method == 'GET' %}
        var map = L.map('map', {zoomControl: false, worldCopyJump: true}).setView([0, 0], 2);
        {% else %}
        var map = L.map('map', {zoomControl: false, worldCopyJump: true}).setView([{{ map_center_lat }}, {{ map_center_lon }}], {{ map_zoom }});
        {% endif %}
        
        L.control.zoom({position: 'bottomleft'}).addTo(map);
        
        var myGeoJSONPath = '{% static "flights/geo/countries-hires.json" %}';
        var myCustomStyle = {
            stroke: true,
            color: '#6e7a8c',
            weight: 0.25,
            fill: true,
            fillColor: '#ccc6b3',
            fillOpacity: 1,
            clickable: false
        }
        
        $.getJSON(myGeoJSONPath, function(data) {
            L.geoJson(data, {
                clickable: false,
                style: myCustomStyle
            }).addTo(map).bringToBack();
        });
        
        var x = 12;
        var icon1 = L.icon({
            iconUrl: "{% static 'flights/img/1.png' %}",
            iconSize: [x, x],
            iconAnchor: [x/2, x/2],
            popupAnchor: [0, 0]
        });
        
        {% if method == 'POST' %}
        
        {% for airport in airports %}
        var marker = new L.marker([{{ airport.latitude }}, {{ airport.longitude }}], {icon: icon1}).bindPopup('{{ airport.name }}').addTo(map);
        {% endfor %}
        
        {% for route in routes %}
        var generator = new arc.GreatCircle({x: {{ route.origin.longitude }}, y: {{ route.origin.latitude }} },
                                            {x: {{ route.destination.longitude }}, y: {{ route.destination.latitude }} },
                                            {'name': 'test'});
        var line = generator.Arc(100, {offset: 10});
        L.geoJson(line.json(), {weight: 2, clickable: false, color: '#646464'}).addTo(map);
        {% endfor %}
        
        {% endif %}
        
        $('#routeform').submit(function(eventObj) {
            var mapCenterLat = map.getCenter().lat;
            var mapCenterLon = map.getCenter().lng;
            var mapZoom = map.getZoom();
            $(this).append('<input type="hidden" name="map_center_lat" value="' + mapCenterLat + '" />');
            $(this).append('<input type="hidden" name="map_center_lon" value="' + mapCenterLon + '" />');
            $(this).append('<input type="hidden" name="map_zoom" value="' + mapZoom + '" />');
            return true;
        });
    }
</script>

<script>
    drawMap();
</script>

{% if method == 'POST' %}
<script>
    showLeftBar();
    printLeftBar('test');
</script>
{% endif %}

{% endblock %}