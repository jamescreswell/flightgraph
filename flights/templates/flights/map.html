{% extends 'flights/base.html' %}
{% load static %}

{% block links %}
<link rel="stylesheet" type="text/css" href="{% static 'flights/css/map.css' %}" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
<script src="{% static 'flights/geo/arc.js' %}"></script>

<!--<script src="http://www.webglearth.com/v2/api.js"></script>-->

<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

<script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
<style>
    .leaflet-container {
        background: #C6ECFF;
    }
</style>
{% endblock %}

{% block content %}
<div id="map">
</div>

<aside id="airport-panel">
    <header>
        <div id="airport-name"></div>
        <div id="airport-location"></div>
        <div id="airport-codes"></div>
        <div id="airport-flag"></div>
        <!--<button class="airport-panel-close"><i class="fa fa-times"></i></button>-->
    </header>
    <section id="airport-flights">
        <ol id="flights-list">
            <!--Needs tabs for flight list, stats-->
        </ol>
    </section>
</aside>
<!--<div id="close-button">
    <i class="fa fa-angle-left"></i>
</div>-->


<script>
    // Create map in element with id 'map'
    var map = L.map('map', {
        zoomControl: false,
        worldCopyJump: true,
        inertia: false
    }).setView([25, 0], 3);

    // Add zoom control to map
    L.control.zoom({position: 'bottomright'}).addTo(map);

    // Set GEOjson path
    var geoJSONPath = '{% static "flights/geo/ne_10m_admin_0_countries_lakes.json" %}';

    // Define map style
    var mapStyle = {
        stroke: true,
        color: '#6e7a8c',
        weight: 0.25,
        fill: true,
        fillColor: '#87b8a1',
        fillOpacity: 1,
        clickable: false
    }

    // Create map layer group to hold map tiles
    var mapLayer = new L.LayerGroup().addTo(map);

    // No idea how this works but it does
    $.getJSON(geoJSONPath, function(data) {
        //L.geoJson(data, {
        //    clickable: false,
        //    pane: 'tilePane',
        //    style: mapStyle
        //}).addTo(mapLayer);
        var vectorGrid = L.vectorGrid.slicer(data, {
            vectorTileLayerStyles: {
                sliced: function(properties, zoom) {
                    return {
                        fillColor: '#FEFEE9',//'#87B8A1',
                        stroke: true,
                        fill: true,
                        color: '#646464',
                        weight: 0.25,
                        fillOpacity: 1,
                    }
                }
            },
        })
        .addTo(mapLayer);
    });

    // Create airport icon
    var x = 12;
    var icon1 = L.icon({
        iconUrl: "{% static 'flights/img/airport-icon-red.png' %}",
        iconSize: [x, x],
        iconAnchor: [x/2, x/2],
        popupAnchor: [0, 0]
    });

    // Create layer groups for lines and markers
    var markersLayer = new L.LayerGroup().addTo(map);
    var linesLayer = new L.LayerGroup().addTo(map);

    // ?
    var baseLayers = {
    };

    // For layer group control
    var overlays = {
        "Airports": markersLayer,
        "Routes": linesLayer,
        "Map": mapLayer
    };
    L.control.layers(baseLayers, overlays, {position: 'bottomright'}).addTo(map);
    
    map.on('click', function(e) {        
        if (document.getElementById('airport-panel').style.display != 'none') {
            document.getElementById('airport-panel').style.display = 'none';
            drawAllRoutes();
        }
    });
</script>

<script>    
    function airportClick(e) {
        $('#airport-panel').show();
        
        fill_airport_title(this.id);
        fill_airport_flights(this.id);
    }
        
    function fill_airport_title(id) {
        fetch('/api/get_airport/' + id).then(
            function(response) {                
                response.json().then(function(data) {
                    console.log('JSON received');
                    console.log(data);
                    document.getElementById('airport-name').innerHTML = data['name'];
                    
                    if (data['country_iso'] == 'US' || data['country_iso'] == 'GB') {
                        document.getElementById('airport-location').innerHTML = data['city'] + ', ' + data['region'] + ', ' + data['country'];
                    }
                    else {
                        document.getElementById('airport-location').innerHTML = data['city'] + ', ' + data['country'];
                    }
                    
                    document.getElementById('airport-codes').innerHTML = data['iata'] + '/' + data['icao'];
                    
                    document.getElementById('airport-flag').innerHTML = '<img src="/static/flights/img/flags/32/' + data['country_iso'] + '.png" title="' + data['country'] + '">';
                    if (data['country_iso'] == 'GB') {
                        document.getElementById('airport-flag').innerHTML += '<br><img src="/static/flights/img/flags/32/_' + data['region'].toLowerCase() + '.png" title="' + data['region'] + '" style="transform:translateY(-10px);">';
                    }
                });
            }
        );
    }
    
    function fill_airport_flights(id) {
        fetch('/api/get_airport_flights/{{ username }}/' + id).then(
            function(response) {
                response.json().then(function(data) {
                    
                    console.log('JSON received');
                    console.log(data);
                    
                    
                    linesLayer.clearLayers();
                    
                    document.getElementById('flights-list').innerHTML = '';
                    for (i=0; i<data.length; i++) {
                        
                        var generator = new arc.GreatCircle({x: data[i]['origin_long'], y: data[i]['origin_lat'] },
                                                            {x: data[i]['destination_long'], y: data[i]['destination_lat'] },
                                                            {'name': 'test'});
                        var line = generator.Arc(100, {offset: 10});
                        var lineMarker = new L.geoJson(line.json(), {weight: 1.5, clickable: false, color: '#e41a1c', opacity: 1.0});
                        linesLayer.addLayer(lineMarker);
                        
                        
                        var newrow = '<li class="flight-summary" id="flight-' + i.toString() + '" onclick="toggleFlightDetails(' + i.toString() + ',' + data[i]['origin_long'].toString() + ',' + data[i]['origin_lat'].toString() + ',' + data[i]['destination_long'].toString() + ',' + data[i]['destination_lat'].toString() + ');" style="cursor:pointer;">';
                        // row onclick: expand, show pic and length and details and registration, highlight on map
                        
                        var date = new Date(data[i]['date']);
                        var shortMonthName = new Intl.DateTimeFormat("en-US", { month: "short" }).format;
                        var shortName = shortMonthName(date); // "Jul"
                        
                        newrow += '<div class="flight-arrow" id="flight-arrow-' + i.toString() + '"><i class="fa fa-angle-down"></i></div>';
                        
                        newrow += '<div class="flight-date">' + date.getDate() + ' ' + shortName + '<br>' + date.getFullYear() + '</div>';
                        
                        newrow += '<div class="flight-route">';
                        if (data[i]['direction'] == 'arrival') {
                            newrow += '<abbr title="arrived from ' + data[i]['city'] + '">↘<span style="font-weight:700;">' + data[i]['origin'] + '</span>';
                        }
                        else {
                            newrow += '<abbr title="departed to ' + data[i]['city'] + '">↗<span style="font-weight:700;">' + data[i]['destination'] + '</span>';
                        }
                        newrow += '<br>' + data[i]['number'] + '</abbr></div>';
                        
                        newrow += '<div class="flight-plane">' + data[i]['airline'] + '<br><nobr>' + data[i]['plane'].substring(0,200) + '</nobr></div>';
                        
                        newrow += '</li>';
                        
                        document.getElementById('flights-list').innerHTML += newrow;
                        
                        
                        var hiddenrows = '<li class="flight-details" id="flight-details-' + i.toString() + '" style="display:none;">';
                        
                        if (data[i]['picture'] != '') {
                            hiddenrows += '<img class="flight-details-img" src="' + data[i]['picture'] + '"><br>';
                        }
                        
                        hiddenrows += '<div><span style="font-variant:small-caps;">From</span><br><span style="font-weight:700;">' + data[i]['origin'] + '</span></div><div><span style="font-variant:small-caps;">To</span><br><span style="font-weight:700;">' + data[i]['destination'] + '</span></div>';
                        
                        hiddenrows += '<div><span style="font-variant:small-caps;">Distance</span><br><span style="font-weight:700;">' + data[i]['distance'] + ' mi</span></div>';
                        hiddenrows += '<div><span style="font-variant:small-caps;">Approximate duration</span><br><span style="font-weight:700;">' + data[i]['duration'] + ' hr</span></div><br>';
                        
                        hiddenrows += '<div><span style="font-variant:small-caps;">Airline</span><br><span style="font-weight:700;">' + data[i]['airline'] + '</span></div>';
                        
                        if (data[i]['operator'] != '') {
                            hiddenrows += '<div><span style="font-variant:small-caps;">Operator</span><br><span style="font-weight:700;">' + data[i]['operator'] + '</span></div>';
                        }
                        hiddenrows += '<br>';
                        
                        hiddenrows += '<div class="flight-details-plane"><span style="font-variant:small-caps;">Aircraft</span><br><span style="font-weight:700;">' + data[i]['plane'] + '</span></div>';
                        
                        hiddenrows += '<div><span style="font-variant:small-caps;">Registration</span><br><span style="font-weight:700;">' + data[i]['registration'] + '</span></div><br>';
                        
                        
                        
                        if (data[i]['class'] != '' | data[i]['seat'] != '') {
                            hiddenrows += '<div><span style="font-variant:small-caps;">Class</span><br><span style="font-weight:700;">' + data[i]['class'] + '</span></div>';
                            hiddenrows += '<div><span style="font-variant:small-caps;">Seat</span><br><span style="font-weight:700;">' + data[i]['seat'] + '</span></div>';
                        }
                        
                        
                        hiddenrows += '</li>';
                        
                        document.getElementById('flights-list').innerHTML += hiddenrows
                    }
                    
                });
            }
        );
    }
    
    function toggleFlightDetails(i, long0, lat0, long1, lat1) {
        // this function could do the api call itself to prevent getting so much data at the beginning...
        var details = document.getElementById('flight-details-' + i)
        if (details.style.display != 'none') {
            details.style.display = 'none';
            document.getElementById('flight-' + i).style.backgroundColor = '#eee';
            document.getElementById('flight-arrow-' + i).innerHTML = '<i class="fa fa-angle-down"></i>';
            document.getElementById('flight-details-' + i).style.cursor = 'default';
            linesLayer.removeLayer(highlightedLineMarkers['route' + i.toString()]);
        }
        else {
            details.style.display = 'list-item';
            document.getElementById('flight-' + i).style.backgroundColor = '#e2e2e2';
            document.getElementById('flight-arrow-' + i).innerHTML = '<i class="fa fa-angle-up"></i>';
            document.getElementById('flight-details-' + i).style.cursor = 'pointer';
            document.getElementById('flight-details-' + i).onclick = function() { toggleFlightDetails(i); };
            var generator = new arc.GreatCircle({x: long0, y: lat0 },
                                                {x: long1, y: lat1 },
                                                {'name': 'test'});
            var line = generator.Arc(100, {offset: 10});
            highlightedLineMarkers['route' + i.toString()] = new L.geoJson(line.json(), {weight: 3.5, clickable: false, color: '#0978AB', opacity: 1.0});
            linesLayer.addLayer(highlightedLineMarkers['route' + i.toString()]);
        }
    }
    
    var highlightedLineMarkers = {};
</script>

<script>
    var coords = [
        {% for airport in airports %}[{{ airport.latitude }}, {{ airport.longitude }}],{% endfor %}
    ]
    
    var ids = [
        {% for airport in airports %}{{ airport.pk }},{% endfor %}
    ]
    
    for (i=0; i<coords.length; i++) {
        var marker = new L.marker(
            coords[i],
            {icon: icon1}
        ).on('click', airportClick, {id: ids[i]});

        markersLayer.addLayer(marker);
    }
</script>

<script>
    function drawAllRoutes() {
        linesLayer.clearLayers();
        
        lats = [
            {% for route in routes %}[{{ route.origin__latitude }}, {{ route.destination__latitude }}],{% endfor %}
        ]
        
        longs = [
            {% for route in routes %}[{{ route.origin__longitude }}, {{ route.destination__longitude }}],{% endfor %}
        ]
        
        for (i = 0; i < lats.length; i++) {
            var generator = new arc.GreatCircle({x: longs[i][0], y: lats[i][0] },
                                                {x: longs[i][1], y: lats[i][1] },
                                                {'name': 'test'});
            var line = generator.Arc(100, {offset: 10});
            var lineMarker = new L.geoJson(line.json(), {weight: 1.5, clickable: false, color: '#e41a1c', opacity: 1.0});
            linesLayer.addLayer(lineMarker);
        }
    }
    
    
    
    
    {% comment %}
    function drawRoutes(airport1, airport2) {
        linesLayer.clearLayers();
 
        
        {% for route in routes %}
        if (airport1 == undefined || airport1 == {{ route.origin__pk }} || airport1 == {{ route.destination__pk }}) {
            if (airport2 == undefined || airport2 == {{route.origin__pk }} || airport2 == {{ route.destination__pk }}) {
                
                var generator = new arc.GreatCircle({x: {{ route.origin__longitude }}, y: {{ route.origin__latitude }} },
                                                    {x: {{ route.destination__longitude }}, y: {{ route.destination__latitude }} },
                                                    {'name': 'test'});
                var line = generator.Arc(100, {offset: 10});
                var lineMarker = new L.geoJson(line.json(), {weight: 1.5, clickable: false, color: '#e41a1c', opacity: 1.0});
                linesLayer.addLayer(lineMarker);

                //var vectorGrid = L.vectorGrid.slicer(line.json()).addTo(linesLayer)

//                var line = generator.Arc(100, {offset: 10});
//                for (i = 0; i < line.geometries[0].coords.length; i++){
//                    line.geometries[0].coords[i][0] += 360;
//                }
//                var lineMarker = new L.geoJson(line.json(), {weight: 1.5, clickable: false, color: '#e41a1c', opacity: 1.0});
//                linesLayer.addLayer(lineMarker);
//
//
//                var line = generator.Arc(100, {offset: 10});
//                for (i = 0; i < line.geometries[0].coords.length; i++){
//                    line.geometries[0].coords[i][0] -= 360;
//                }
//                var lineMarker = new L.geoJson(line.json(), {weight: 1.5, clickable: false, color: '#e41a1c', opacity: 1.0});
//                linesLayer.addLayer(lineMarker);
//
//
//                var generator = new arc.GreatCircle({x: {{ route.destination__longitude }}, y: {{ route.destination__latitude }} },
//                                                    {x: {{ route.origin__longitude }}, y: {{ route.origin__latitude }} },
//                                                    {'name': 'test'});
//                var line = generator.Arc(100, {offset: 10});
//                for (i = 0; i < line.geometries[0].coords.length; i++){
//                    line.geometries[0].coords[i][0] += 360;
//                }
//                var lineMarker = new L.geoJson(line.json(), {weight: 1.5, clickable: false, color: '#e41a1c', opacity: 1.0});
//                linesLayer.addLayer(lineMarker);
//
//
//                var line = generator.Arc(100, {offset: 10});
//                for (i = 0; i < line.geometries[0].coords.length; i++){
//                    line.geometries[0].coords[i][0] -= 360;
//                }
//                var lineMarker = new L.geoJson(line.json(), {weight: 1.5, clickable: false, color: '#e41a1c', opacity: 1.0});
//                linesLayer.addLayer(lineMarker);
            }
        }

        {% endfor %}
    }
         {% endcomment %}
    drawAllRoutes();
</script>



{% endblock %}
